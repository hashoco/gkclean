name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "===== ðŸš€ Starting Deployment ====="

          cd /home/ec2-user/gkclean

          echo "ðŸ“Œ 1) Pull latest code"
          git pull

          echo "ðŸ“Œ 2) Install dependencies"
          npm install

          echo "ðŸ“Œ 3) Generate Prisma Client"
          npx prisma generate

          echo "ðŸ“Œ 4) Build Next.js"
          npm run build

          echo "ðŸ“Œ 5) Restart PM2"
          pm2 restart gkclean || pm2 start npm --name gkclean -- start

          echo "===== ðŸŽ‰ Deployment Completed Successfully ====="
