name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Deploy to EC2 via SSH
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "===== ðŸš€ Starting Deployment ====="

          cd /home/ec2-user/gkclean

          echo "ðŸ“Œ 1) Pull latest code"
          git pull

          echo "ðŸ“Œ 2) Clean cache"
          rm -rf .next
          rm -rf node_modules/.cache

          echo "ðŸ“Œ 3) Install dependencies"
          npm install

          echo "ðŸ“Œ 4) Generate Prisma Client"
          npx prisma generate

          echo "ðŸ“Œ 5) Build Next.js"
          npm run build

          echo "ðŸ“Œ 6) Restart PM2 with clean start"
          pm2 delete gkclean || true
          pm2 start "npm run start:prod" --name gkclean

          echo "===== ðŸŽ‰ Deployment Completed Successfully ====="
